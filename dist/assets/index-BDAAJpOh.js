(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&e(i)}).observe(document,{childList:!0,subtree:!0});function r(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(t){if(t.ep)return;t.ep=!0;const s=r(t);fetch(t.href,s)}})();const v=window.PIXI,E=1408;let _=704;const{innerWidth:ee,innerHeight:te}=window;te>ee*1.3&&(_=E*ee/te,_<320&&(_=320));const u=_,c=35,U=1/120,X=10,j=10,xe=4,y=[{name:"/fruits/fruit_1.png",radius:26,imgRadius:26},{name:"/fruits/fruit_2.png",radius:39,imgRadius:39},{name:"/fruits/fruit_3.png",radius:54,imgRadius:54},{name:"/fruits/fruit_4.png",radius:59.5,imgRadius:59.5},{name:"/fruits/fruit_5.png",radius:76,imgRadius:76},{name:"/fruits/fruit_6.png",radius:91.5,imgRadius:91.5},{name:"/fruits/fruit_7.png",radius:100,imgRadius:93},{name:"/fruits/fruit_8.png",radius:115,imgRadius:129},{name:"/fruits/fruit_9.png",radius:130,imgRadius:154},{name:"/fruits/fruit_10.png",radius:140,imgRadius:151},{name:"/fruits/fruit_11.png",radius:150,imgRadius:202}],w=new v.Application({width:u,height:E,antialias:!0,backgroundColor:16771229}),a=window.b2,we=typeof import.meta<"u"&&"/madeWatermelon/"||"",ne=we.replace(/\/+$/,"")||"";function de(o){const n=o.startsWith("/")?o.slice(1):o;return ne?`${ne}/${n}`:`/${n}`}const oe={};function ue(o,n=1){if(!o)return;const r=de(o);try{let e=oe[r];e||(e=new Audio(r),oe[r]=e),e.volume=Math.max(0,Math.min(1,n)),e.currentTime=0,e.play().catch(()=>{})}catch{}}let g=null;function fe(o,n=.5){const r=de("/sounds/bgm.mp3");try{if(g){g.volume=Math.max(0,Math.min(1,n)),g.play().catch(()=>{});return}g=new Audio(r),g.loop=!0,g.volume=Math.max(0,Math.min(1,n)),g.play().catch(()=>{})}catch{}}function be(){g&&(g.pause(),g.currentTime=0)}function Se(){return!!(g&&!g.paused)}const{Sprite:Ee,Loader:L}=v,re=v.Graphics,M=new a.World({x:0,y:xe});function Be(){let n=L.shared.resources["__placeholder"]?.texture;if(n)return n;const r=v.Texture;return r?.WHITE?r.WHITE:r?.EMPTY?r.EMPTY:null}const se=20,Ge=80,Me=20,De=1800;let F=!1,pe=()=>{};const Le=o=>{pe=o};let S;const Ie=()=>{const o=new a.BodyDef,n=new a.FixtureDef;o.type=a.staticBody,n.density=0,n.friction=.2,n.restitution=.3,n.filter.groupIndex=-20,n.shape=new a.ChainShape().CreateLoop([{x:0,y:0/c},{x:0,y:E/c},{x:u/c,y:E/c},{x:u/c,y:0/c}]);const r=M.CreateBody(o);r.CreateFixture(n),r.SetUserData({type:-1})},J=150/c,N=new a.BodyDef;N.type=a.dynamicBody;N.position.Set(u/2/c,J);const Z=y.map(o=>{const n=new a.FixtureDef;return n.density=.03,n.friction=.6,n.restitution=0,n.shape=new a.CircleShape(o.radius/c),n.filter.groupIndex=1,n});let G=0;const p={},$=new Map,b=new Map,Te=100,Ce=.05,f=new Set,k=(o,n=-299,r=-299)=>{const e=y[o],t=new Ee;t.anchor.set(.5),t.x=n,t.y=r;const s=L.shared.resources[e.name]?.texture;s||(console.error(`纹理未找到: ${e.name}，请确保 public/fruits/ 下有对应图片`),console.log("Loader.resources 中的键:",Object.keys(L.shared.resources||{})));const i=s||L.shared.resources["/fruits/fruit_1.png"]?.texture||Be();return i&&(t.texture=i),t.scale.set(e.radius/e.imgRadius),t},l={current:0,next:0};let x,W;const Pe=()=>{let o=0,n=0;Object.defineProperty(l,"current",{get(){return o},set(r){o=r;const e=y[r],t=L.shared.resources[e.name]?.texture;t&&(x.texture=t),x.scale.set(e.radius/e.imgRadius)}}),Object.defineProperty(l,"next",{get(){return n},set(r){n=r;const e=y[r],t=L.shared.resources[e.name]?.texture;t&&(W.texture=t),W.scale.set(e.radius/e.imgRadius)}})};Pe();const ie=(o,n=u/2)=>{ue("/sounds/drop.mp3");let r=n;n<5&&(r=5),n>u-5&&(r=u-5);const e=M.CreateBody(N);e.SetSleepingAllowed(!0),e.SetPositionXY(r/c,J),e.CreateFixture(Z[o]),e.SetUserData({type:o,id:G});const t=k(o);w.stage.addChild(t),p[G++]={body:e,sprite:t,spawnTime:Date.now()},l.current=l.next,G<4?l.next=Math.floor(Math.random()*2):G<8?l.next=Math.floor(Math.random()*3):G<16?l.next=Math.round(Math.random()*3.5):l.next=Math.round(Math.random()*4)},R=[];function K(o,n){const r=p[o],e=p[n];if(!r||!e)return!1;const t=r.body.GetPosition(),s=e.body.GetPosition(),i=r.body.GetUserData().type,d=e.body.GetUserData().type;if(i!==d||i>=10)return!1;const m=y[i].radius/c,h=y[d].radius/c,B=t.x-s.x,D=t.y-s.y;return Math.sqrt(B*B+D*D)<=m+h+Ce}const H=()=>{$.forEach((o,n)=>{if(!K(n,o))return;let r=p[o],e=p[n];if(r.body.GetPosition().y>e.body.GetPosition().y){const m=r;r=e,e=m}e.body.DestroyFixture(e.body.GetFixtureList());const t=e.body.GetUserData();e.body.CreateFixture(Z[t.type+1]),e.body.SetUserData({...t,type:t.type+1}),f.delete(n),f.delete(o),delete p[r.body.GetUserData().id],M.DestroyBody(r.body),w.stage.removeChild(r.sprite);const s=y[t.type+1];e.sprite.texture=L.shared.resources[s.name].texture,ue("/sounds/merge.mp3");const i=s.radius/s.imgRadius,d=i*.5;e.sprite.scale.set(d),R.push({sprite:e.sprite,targetScale:i,currentScale:d,progress:0})}),$.clear()};function Y(){const o=Object.keys(p).map(Number);for(let n=0;n<o.length;n++)for(let r=n+1;r<o.length;r++){const e=Math.min(o[n],o[r]),t=Math.max(o[n],o[r]);if(!(f.has(e)||f.has(t))&&!(b.has(e)&&b.get(e).maxId===t)&&K(e,t)){b.set(e,{maxId:t,startTime:Date.now()}),f.add(e),f.add(t);return}}}const me=()=>{const o=Date.now();b.forEach((e,t)=>{if(!K(t,e.maxId)){b.delete(t),f.delete(t),f.delete(e.maxId);return}o-e.startTime>=Te&&($.set(t,e.maxId),b.delete(t),f.delete(t),f.delete(e.maxId))}),M.Step(U,X,j),Y(),H(),M.Step(U,X,j),Y(),H(),M.Step(U,X,j),Y(),H();const n=.008;for(let e=R.length-1;e>=0;e--){const t=R[e];if(t.progress+=n,t.progress>=1)t.sprite.scale.set(t.targetScale),R.splice(e,1);else{const s=t.progress,i=1.70158,m=1+(i+1)*Math.pow(s-1,3)+i*Math.pow(s-1,2),h=t.currentScale+(t.targetScale-t.currentScale)*m;t.sprite.scale.set(h)}}let r=!1;Object.keys(p).forEach(e=>{const t=p[e],{body:s,sprite:i}=t,{x:d,y:m}=s.GetPosition(),h=s.GetAngle();if(i.x=d*c,i.y=m*c,i.rotation=h,Date.now()-t.spawnTime<De)return;const D=y[s.GetUserData().type].radius,I=m*c-D;I<Ge&&(r=!0),!F&&I<Me&&(F=!0,pe())});try{if(S&&(S.clear(),!F&&r)){const e=.4+.6*Math.sin(Date.now()/180);S.lineStyle(4,16711680,e),S.moveTo(0,se),S.lineTo(u,se)}}catch{S=null}requestAnimationFrame(me)},O=document.getElementById("root");let ae=0;const ce=()=>{const o=new Date().getTime();return o-ae<100?!0:(ae=o,!1)},ve=()=>{console.log("游戏初始化开始");const o=document.getElementsByTagName("canvas")[0];o.addEventListener("touchmove",e=>{const{changedTouches:t}=e;if(t.length!==1)return;const s=parseFloat(getComputedStyle(O).marginLeft),{clientX:i}=t[0],d=(i-s)/parseFloat(O.childNodes[0].style.transform.slice(6));x.x=d}),o.addEventListener("touchend",e=>{if(ce())return;const{changedTouches:t}=e;if(t.length!==1)return;const s=parseFloat(getComputedStyle(O).marginLeft),{clientX:i}=t[0],d=(i-s)/parseFloat(O.childNodes[0].style.transform.slice(6));x.x=u/2,ie(l.current,d)}),o.addEventListener("mousemove",e=>{if("ontouchend"in window)return;const{offsetX:t}=e;x.x=t}),o.addEventListener("click",e=>{if("ontouchend"in window||ce())return;const{offsetX:t}=e;x.x=t,ie(l.current,t)}),Ie(),x=k(l.current,u/2,J*c),W=k(l.next,u/2,50),x.visible=!0,x.alpha=1,W.visible=!1,w.stage.addChild(x);try{re&&(S=new re,w.stage.addChild(S))}catch(e){console.warn("红线 Graphics 初始化失败，已跳过",e),S=null}console.log(`app.stage子元素数量: ${w.stage.children.length}`),console.log(`app.stage尺寸: width=${w.stage.width}, height=${w.stage.height}`);const n=new a.WorldManifold,r=new a.Vec2;a.ContactListener.prototype.PreSolve=e=>{const t=e.GetFixtureA().GetBody(),s=e.GetFixtureB().GetBody(),i=t.GetUserData(),d=s.GetUserData();if(i.type!==d.type||i.type>=10)return;const m=Math.min(i.id,d.id),h=Math.max(i.id,d.id);e.GetWorldManifold(n);const B=n.normal,D=t.GetLinearVelocity(),I=s.GetLinearVelocity(),ge=a.Vec2.DotVV(D,B),he=a.Vec2.DotVV(I,B);if(a.Vec2.SubVV(D,a.Vec2.MulSV(ge,B,r),r),t.SetLinearVelocity(r),a.Vec2.SubVV(I,a.Vec2.MulSV(he,B,r),r),s.SetLinearVelocity(r),f.has(m)||f.has(h)){e.SetEnabled(!1);return}if(b.has(m)&&b.get(m).maxId===h){e.SetEnabled(!1);return}b.set(m,{maxId:h,startTime:Date.now()}),f.add(m),f.add(h),e.SetEnabled(!1)},me()},Oe=()=>{const o={fruits:Object.keys(p).map(n=>{const r=p[n],e=r.body.GetPosition();return{id:parseInt(n),type:r.body.GetUserData().type,x:e.x,y:e.y,angle:r.body.GetAngle()}}),fruitId:G,currentFruit:l.current,nextFruit:l.next};localStorage.setItem("watermelonGame",JSON.stringify(o))},Ae=()=>{const o=localStorage.getItem("watermelonGame");if(o)try{const n=JSON.parse(o);Q(),n.fruits.forEach(r=>{const e=y[r.type],t=M.CreateBody(N);t.SetSleepingAllowed(!0),t.SetPositionXY(r.x,r.y),t.SetAngle(r.angle),t.CreateFixture(Z[r.type]),t.SetUserData({type:r.type,id:r.id});const s=k(r.type);s.x=r.x*c,s.y=r.y*c,s.rotation=r.angle,w.stage.addChild(s),p[r.id]={body:t,sprite:s,spawnTime:Date.now()-1e4}}),G=n.fruitId,l.current=n.currentFruit,l.next=n.nextFruit}catch(n){console.error("加载游戏失败:",n)}},Q=()=>{Object.keys(p).forEach(o=>{const n=p[o];M.DestroyBody(n.body),w.stage.removeChild(n.sprite),delete p[o]}),$.clear(),b.clear(),f.clear(),G=0,l.current=0,l.next=0,F=!1};let A;console.log("=== PWA 调试信息 ===");console.log("Service Worker 支持:","serviceWorker"in navigator);console.log("beforeinstallprompt 支持:","onbeforeinstallprompt"in window);window.addEventListener("beforeinstallprompt",o=>{console.log("=== beforeinstallprompt 事件触发 ==="),o.preventDefault(),A=o,console.log("安装提示已保存，可以显示安装按钮");const n=document.getElementById("installBtn");n&&(n.style.display="block",console.log("安装按钮已显示"),n.addEventListener("click",()=>{console.log("用户点击了安装按钮"),A.prompt(),A.userChoice.then(r=>{r.outcome==="accepted"?console.log("用户接受了安装提示"):console.log("用户拒绝了安装提示"),A=null,n&&(n.style.display="none")})}))});window.addEventListener("appinstalled",()=>{console.log("=== 应用已安装 ===");const o=document.getElementById("installBtn");o&&(o.style.display="none")});const{Loader:T}=v,_e=typeof import.meta<"u"&&"/madeWatermelon/"||"",le=_e.replace(/\/+$/,"")||"",V=y.map(o=>{const n=o.name.startsWith("/")?o.name.slice(1):o.name;return le?le+"/"+n:"/"+n}),C=document.getElementById("root"),P=w.view;C.appendChild(P);typeof T.shared.reset=="function"&&T.shared.reset();console.log("开始加载纹理...",V);T.shared.add(V).load((o,n)=>{console.log("纹理加载完成"),console.log("加载的资源键:",Object.keys(n)),y.forEach((r,e)=>{const t=n[V[e]]||n[r.name];t?.texture&&!n[r.name]&&(n[r.name]=t)}),y.forEach(r=>{const e=T.shared.resources[r.name]||n[V[y.indexOf(r)]];e?.texture||(z=!0),console.log(`${r.name}: 纹理存在=${!!e?.texture}`)}),z&&Fe(),Le(()=>{const r=document.getElementById("failOverlay");r&&(r.style.display="flex")}),ve(),fe(void 0,.5)});let z=!1;T.shared.onError.add(o=>{z=!0,console.warn("纹理加载失败（请将 fruit_1.png～fruit_11.png 放入 public/fruits/ 目录）:",o?.message||o)});function Fe(){const o=document.getElementById("textureTip");o&&(o.style.display="block")}T.shared.onProgress.add(o=>{console.log(`加载进度: ${o.progress}%`)});const ye=()=>{const{innerWidth:o,innerHeight:n}=window;document.body.style.height=`${n}px`,o/n>u/E?(C.style.height=`${n}px`,C.style.width=`${n/E*u}px`,P.style.transform=`scale(${n/E})`):(C.style.width=`${o}px`,C.style.height=`${o/u*E}px`,P.style.transform=`scale(${o/u})`)};P.style.width=`${u}px`;P.style.height=`${E}px`;ye();window.onresize=ye;document.getElementById("saveBtn")?.addEventListener("click",Oe);document.getElementById("loadBtn")?.addEventListener("click",Ae);document.getElementById("clearBtn")?.addEventListener("click",Q);document.getElementById("failConfirmBtn")?.addEventListener("click",()=>{Q();const o=document.getElementById("failOverlay");o&&(o.style.display="none")});document.getElementById("textureTipClose")?.addEventListener("click",()=>{document.getElementById("textureTip").style.display="none"});const q=document.getElementById("bgmBtn");q?.addEventListener("click",()=>{Se()?(be(),q.textContent="BGM 播放"):(fe(void 0,.5),q.textContent="BGM 静音")});
