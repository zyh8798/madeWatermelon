(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function e(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=e(r);fetch(r.href,i)}})();const v=window.PIXI,f=1408;let C=704;const{innerWidth:_,innerHeight:A}=window;A>_*1.3&&(C=f*_/A,C<320&&(C=320));const d=C,a=35,W=1/120,I=10,P=10,h=[{name:"/madeWatermelon/fruits/fruit_1.png",radius:26,imgRadius:26},{name:"/madeWatermelon/fruits/fruit_2.png",radius:39,imgRadius:39},{name:"/madeWatermelon/fruits/fruit_3.png",radius:54,imgRadius:54},{name:"/madeWatermelon/fruits/fruit_4.png",radius:59.5,imgRadius:59.5},{name:"/madeWatermelon/fruits/fruit_5.png",radius:76,imgRadius:76},{name:"/madeWatermelon/fruits/fruit_6.png",radius:91.5,imgRadius:91.5},{name:"/madeWatermelon/fruits/fruit_7.png",radius:100,imgRadius:93},{name:"/madeWatermelon/fruits/fruit_8.png",radius:115,imgRadius:129},{name:"/madeWatermelon/fruits/fruit_9.png",radius:130,imgRadius:154},{name:"/madeWatermelon/fruits/fruit_10.png",radius:140,imgRadius:151},{name:"/madeWatermelon/fruits/fruit_11.png",radius:150,imgRadius:202}],x=new v.Application({width:d,height:f,antialias:!0,backgroundColor:16771229}),u=window.b2,{Sprite:j,Loader:D}=v,y=new u.World({x:0,y:10}),q=()=>{const n=new u.BodyDef,t=new u.FixtureDef;n.type=u.staticBody,t.density=0,t.friction=.2,t.restitution=.3,t.filter.groupIndex=-20,t.shape=new u.ChainShape().CreateLoop([{x:0,y:0/a},{x:0,y:f/a},{x:d/a,y:f/a},{x:d/a,y:0/a}]);const e=y.CreateBody(n);e.CreateFixture(t),e.SetUserData({type:-1})},O=150/a,G=new u.BodyDef;G.type=u.dynamicBody;G.position.Set(d/2/a,O);const M=h.map((n,t)=>{const e=new u.FixtureDef;return e.density=.1,e.friction=.2,e.restitution=.3,e.shape=new u.CircleShape(n.radius/a),e.filter.groupIndex=1,e});let p=0;const c={},S=new Map,g=new Set,F=(n,t=-299,e=-299)=>{const o=h[n],r=new j;return r.anchor.set(.5),r.x=t,r.y=e,r.texture=D.shared.resources[o.name].texture,r.scale.set(o.radius/o.imgRadius),r},s={current:0,next:0};let m,L;const H=()=>{let n=0,t=0;Object.defineProperty(s,"current",{get(){return n},set(e){n=e;const o=h[e];m.texture=D.shared.resources[o.name].texture,m.scale.set(o.radius/o.imgRadius)}}),Object.defineProperty(s,"next",{get(){return t},set(e){t=e;const o=h[e];L.texture=D.shared.resources[o.name].texture,L.scale.set(o.radius/o.imgRadius)}})};H();const N=(n,t=d/2)=>{let e=t;t<5&&(e=5),t>d-5&&(e=d-5);const o=y.CreateBody(G);o.SetSleepingAllowed(!0),o.SetPositionXY(e/a,O),o.CreateFixture(M[n]),o.SetUserData({type:n,id:p});const r=F(n);x.stage.addChild(r),c[p++]={body:o,sprite:r},s.current=s.next,p<4?s.next=Math.floor(Math.random()*2):p<8?s.next=Math.floor(Math.random()*3):p<16?s.next=Math.round(Math.random()*3.5):s.next=Math.round(Math.random()*4)},R=()=>{S.forEach((n,t)=>{let e=c[n],o=c[t];if(e.body.GetPosition().y>o.body.GetPosition().y){const l=e;e=o,o=l}o.body.DestroyFixture(o.body.GetFixtureList());const r=o.body.GetUserData();o.body.CreateFixture(M[r.type+1]),o.body.SetUserData({...r,type:r.type+1}),g.delete(t),g.delete(n),delete c[e.body.GetUserData().id],y.DestroyBody(e.body),x.stage.removeChild(e.sprite);const i=h[r.type+1];o.sprite.texture=D.shared.resources[i.name].texture,o.sprite.scale.set(i.radius/i.imgRadius)}),S.clear()},U=()=>{y.Step(W,I,P),R(),y.Step(W,I,P),R(),y.Step(W,I,P),R(),Object.keys(c).forEach(n=>{const t=c[n],{body:e,sprite:o}=t,{x:r,y:i}=e.GetPosition(),l=e.GetAngle();o.x=r*a,o.y=i*a,o.rotation=l}),requestAnimationFrame(U)},B=document.getElementById("root");let X=0;const $=()=>{const n=new Date().getTime();return n-X<100?!0:(X=n,!1)},Y=()=>{const n=document.getElementsByTagName("canvas")[0];n.addEventListener("touchmove",t=>{const{changedTouches:e}=t;if(e.length!==1)return;const o=parseFloat(getComputedStyle(B).marginLeft),{clientX:r}=e[0],i=(r-o)/parseFloat(B.childNodes[0].style.transform.slice(6));m.x=i}),n.addEventListener("touchend",t=>{if($())return;const{changedTouches:e}=t;if(e.length!==1)return;const o=parseFloat(getComputedStyle(B).marginLeft),{clientX:r}=e[0],i=(r-o)/parseFloat(B.childNodes[0].style.transform.slice(6));m.x=d/2,N(s.current,i)}),n.addEventListener("mousemove",t=>{if("ontouchend"in window)return;const{offsetX:e}=t;m.x=e}),n.addEventListener("click",t=>{if("ontouchend"in window||$())return;const{offsetX:e}=t;m.x=e,N(s.current,e)}),q(),m=F(s.current,d/2,O*a),L=F(s.next,d/2,0),x.stage.addChild(m),x.stage.addChild(L),u.ContactListener.prototype.PreSolve=t=>{const e=t.GetFixtureA().GetBody().GetUserData(),o=t.GetFixtureB().GetBody().GetUserData();if(e.type!==o.type||e.type>=10)return;const r=Math.min(e.id,o.id),i=Math.max(e.id,o.id),l=S.get(r);if(!l){if(g.has(r)||g.has(i))return;S.set(r,i),g.add(r),g.add(i),t.SetEnabled(!1);return}l===i&&t.SetEnabled(!1)},U()},z=()=>{const n={fruits:Object.keys(c).map(t=>{const e=c[t],o=e.body.GetPosition();return{id:parseInt(t),type:e.body.GetUserData().type,x:o.x,y:o.y,angle:e.body.GetAngle()}}),fruitId:p,currentFruit:s.current,nextFruit:s.next};localStorage.setItem("watermelonGame",JSON.stringify(n))},J=()=>{const n=localStorage.getItem("watermelonGame");if(n)try{const t=JSON.parse(n);k(),t.fruits.forEach(e=>{const o=h[e.type],r=y.CreateBody(G);r.SetSleepingAllowed(!0),r.SetPositionXY(e.x,e.y),r.SetAngle(e.angle),r.CreateFixture(M[e.type]),r.SetUserData({type:e.type,id:e.id});const i=F(e.type);i.x=e.x*a,i.y=e.y*a,i.rotation=e.angle,x.stage.addChild(i),c[e.id]={body:r,sprite:i}}),p=t.fruitId,s.current=t.currentFruit,s.next=t.nextFruit}catch(t){console.error("加载游戏失败:",t)}},k=()=>{Object.keys(c).forEach(n=>{const t=c[n];y.DestroyBody(t.body),x.stage.removeChild(t.sprite),delete c[n]}),S.clear(),g.clear(),p=0,s.current=0,s.next=0};let E;console.log("=== PWA 调试信息 ===");console.log("Service Worker 支持:","serviceWorker"in navigator);console.log("beforeinstallprompt 支持:","onbeforeinstallprompt"in window);window.addEventListener("beforeinstallprompt",n=>{console.log("=== beforeinstallprompt 事件触发 ==="),n.preventDefault(),E=n,console.log("安装提示已保存，可以显示安装按钮");const t=document.getElementById("installBtn");t&&(t.style.display="block",console.log("安装按钮已显示"),t.addEventListener("click",()=>{console.log("用户点击了安装按钮"),E.prompt(),E.userChoice.then(e=>{e.outcome==="accepted"?console.log("用户接受了安装提示"):console.log("用户拒绝了安装提示"),E=null,t&&(t.style.display="none")})}))});window.addEventListener("appinstalled",()=>{console.log("=== 应用已安装 ===");const n=document.getElementById("installBtn");n&&(n.style.display="none")});const{Loader:K}=v,V=h.map(n=>n.name),w=document.getElementById("root"),b=x.view;w.appendChild(b);K.shared.add(V).load(Y);const T=()=>{const{innerWidth:n,innerHeight:t}=window;document.body.style.height=`${t}px`,n/t>d/f?(w.style.height=`${t}px`,w.style.width=`${t/f*d}px`,b.style.transform=`scale(${t/f})`):(w.style.width=`${n}px`,w.style.height=`${n/d*f}px`,b.style.transform=`scale(${n/d})`)};b.style.width=`${d}px`;b.style.height=`${f}px`;T();window.onresize=T;document.getElementById("saveBtn")?.addEventListener("click",z);document.getElementById("loadBtn")?.addEventListener("click",J);document.getElementById("clearBtn")?.addEventListener("click",k);
